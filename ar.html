<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TADY - AR Interakce</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <style>
        #ar-status { position:fixed; top:10px; left:10px; background:rgba(0,0,0,0.85); color:#00e676; padding:15px; z-index:10000; font-family:sans-serif; border-radius:15px; border:1px solid #00e676; font-size: 14px; }
        .crosshair { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #00e676; border-radius: 50%; transform: translate(-50%, -50%); z-index: 10000; pointer-events: none; opacity: 0.7; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <div id="ar-status">M.D. ONLINE <br> Inicializace...</div>
    <div class="crosshair"></div>

    <a-scene vr-mode-ui="enabled: false" cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-camera gps-camera="simulateAltitude: 1.6" rotation-reader></a-camera>
    </a-scene>

    <script>
        async function poslatLajk(id, textElement) {
            try {
                const res = await fetch('/api/like-trace', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                if (res.ok) {
                    // Okamžitá vizuální zpětná vazba v AR
                    alert("Stopa olajkována!");
                    location.reload(); // Obnoví AR pro načtení nového počtu lajků
                }
            } catch (err) { console.error("Chyba lajkování:", err); }
        }

        window.onload = async () => {
            const statusBox = document.getElementById('ar-status');
            try {
                const res = await fetch('/api/get-traces');
                const data = await res.json();
                const scene = document.querySelector('a-scene');
                statusBox.innerHTML = `M.D. ONLINE <br> Objekty v dosahu: ${data.length}`;

                data.forEach(stopa => {
                    const container = document.createElement('a-entity');
                    container.setAttribute('gps-entity-place', `latitude: ${stopa.lat}; longitude: ${stopa.lng};`);
                    
                    let barva = "#00e676"; // Veřejný
                    if (stopa.content.includes("[public-ad]")) barva = "#ffd700"; // Reklama
                    if (stopa.content.includes("[private]")) barva = "#ff3d00"; // Soukromý

                    // INTERAKTIVNÍ FOTKA
                    if (stopa.image_url) {
                        const img = document.createElement('a-image');
                        img.setAttribute('src', stopa.image_url);
                        img.setAttribute('scale', '12 12 12');
                        img.setAttribute('position', '0 5 0');
                        img.setAttribute('look-at', '[gps-camera]');
                        img.setAttribute('class', 'clickable');
                        
                        // Po kliknutí na fotku se pošle lajk
                        img.addEventListener('click', () => poslatLajk(stopa.id));
                        container.appendChild(img);
                    }

                    // TEXT + POČÍTADLO LAJKŮ
                    const text = document.createElement('a-text');
                    const cistyText = stopa.content.split('] ')[1] || stopa.content;
                    const pocetLajku = stopa.likes || 0;
                    
                    text.setAttribute('value', `${cistyText}\n❤️ ${pocetLajku}`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('color', barva);
                    text.setAttribute('scale', '8 8 8');
                    text.setAttribute('position', '0 -2 0');
                    text.setAttribute('look-at', '[gps-camera]');
                    text.setAttribute('class', 'clickable');
                    text.addEventListener('click', () => poslatLajk(stopa.id));

                    container.appendChild(text);
                    scene.appendChild(container);
                });
            } catch (err) { statusBox.innerText = "Chyba sítě."; }
        };
    </script>
</body>
</html>
