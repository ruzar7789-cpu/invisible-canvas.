
<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TADY // UNIVERSE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        
        :root { --p: #00f2fe; --b: #ffca2c; --c: #bf5af2; --red: #ff3b30; }
        body, html { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; margin: 0; padding: 0; overflow: hidden; height: 100vh; }

        /* INTRO SEKVENCE */
        #intro-layer {
            position: fixed; inset: 0; z-index: 10000; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 1.2s cubic-bezier(0.8, 0, 0.2, 1), opacity 1s;
        }
        .intro-logo { font-size: 5rem; font-weight: 800; italic; letter-spacing: -5px; color: white; animation: logo-glow 3s infinite; }
        @keyframes logo-glow { 0%, 100% { text-shadow: 0 0 20px var(--p); } 50% { text-shadow: 0 0 50px var(--p), 0 0 80px var(--c); } }

        /* ENGINE VRSTVY */
        #map { position: fixed; inset: 0; z-index: 10; transition: 0.6s; }
        #camera-preview { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; opacity: 0; }
        
        /* PROFESSIONÁLNÍ UI */
        .glass-dark { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; color: white; }
        .glass-light { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(0,0,0,0.05); border-radius: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        
        .action-btn { width: 60px; height: 60px; border-radius: 20px; display: flex; align-items: center; justify-content: center; transition: 0.3s; pointer-events: auto; }
        .record-pulse { animation: pulse-red 1.5s infinite; background: var(--red) !important; color: white; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }

        /* MARKERS */
        .custom-marker { width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        
        /* MEDIA PREVIEW */
        .preview-box { width: 100%; height: 150px; border-radius: 20px; background: #f0f0f0; overflow: hidden; margin-bottom: 15px; position: relative; }
        #captured-image { width: 100%; height: 100%; object-fit: cover; display: none; }
    </style>
</head>
<body>

    <div id="intro-layer">
        <div class="intro-logo">TADY</div>
        <div class="text-[10px] tracking-[0.8em] text-white/40 uppercase mt-4">Universe Protocol Active</div>
        <div class="w-1 h-20 bg-gradient-to-b from-cyan-400 to-transparent mt-10"></div>
        <button onclick="unlockUniverse()" class="mt-10 px-12 py-4 border border-white/20 rounded-full font-black text-[10px] tracking-[0.4em] uppercase text-white hover:bg-white hover:text-black transition-all">Connect</button>
    </div>

    <video id="camera-preview" autoplay playsinline muted></video>
    <div id="map"></div>

    <div class="fixed inset-0 z-[100] pointer-events-none p-6 flex flex-col justify-between">
        
        <div class="flex justify-between items-start">
            <div class="glass-dark p-6 pointer-events-auto">
                <h1 class="text-3xl font-black italic leading-none">TADY</h1>
                <p class="text-[7px] tracking-[0.4em] opacity-40 uppercase font-bold mt-1">Varnsdorf Terminal // M.D.</p>
            </div>
            <button onclick="toggleCamera()" class="action-btn glass-dark pointer-events-auto text-xl">
                <i id="cam-icon" class="fas fa-camera"></i>
            </button>
        </div>

        <div id="capture-zone" class="hidden pointer-events-auto flex flex-col items-center">
            <div class="glass-light p-6 w-full max-w-sm flex flex-col items-center">
                <div class="preview-box" id="p-box">
                    <div id="p-hint" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-image text-3xl mb-2"></i>
                        <span class="text-[9px] font-bold uppercase">Žádné médium</span>
                    </div>
                    <img id="captured-image">
                    <canvas id="hidden-canvas" class="hidden"></canvas>
                </div>
                <div class="flex gap-4 mb-6">
                    <button onclick="takePhoto()" class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-camera"></i></button>
                    <button onclick="toggleRecord()" id="rec-btn" class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                </div>
                <input type="text" id="trace-text" placeholder="Tvůj vzkaz..." class="w-full bg-gray-100 p-4 rounded-xl font-bold mb-4 outline-none">
                <button onclick="publishTrace()" class="w-full bg-black text-white py-5 rounded-2xl font-black text-[10px] tracking-[0.5em] uppercase">Publish Trace</button>
                <button onclick="closeCapture()" class="mt-4 text-[9px] font-black opacity-30 uppercase tracking-widest">Zrušit</button>
            </div>
        </div>

        <div class="w-full max-w-lg mx-auto pointer-events-auto flex flex-col items-center">
             <button id="main-add-btn" onclick="openCapture()" class="w-20 h-20 bg-white text-black rounded-full shadow-2xl flex items-center justify-center text-2xl mb-6 active:scale-90 transition-all">
                <i class="fas fa-plus"></i>
            </button>
            <div class="glass-dark p-4 flex gap-6 px-10">
                <button onclick="setMode('p')" id="m-p" class="text-cyan-400 transition-all scale-125"><i class="fas fa-user"></i></button>
                <button onclick="setMode('b')" id="m-b" class="opacity-30 transition-all"><i class="fas fa-briefcase"></i></button>
                <button onclick="setMode('c')" id="m-c" class="opacity-30 transition-all"><i class="fas fa-users"></i></button>
            </div>
        </div>
    </div>

    <script>
        let map, traces = [], currentMode = 'p', isRecording = false;
        let capturedPhotoData = null;
        const themes = { p: '#00f2fe', b: '#ffca2c', c: '#bf5af2' };

        // INITIALIZE
        function unlockUniverse() {
            document.getElementById('intro-layer').style.opacity = '0';
            document.getElementById('intro-layer').style.transform = 'translateY(-100%)';
            setTimeout(() => {
                document.getElementById('intro-layer').style.display = 'none';
                initSystem();
            }, 1000);
            playSnd(523, 0.1);
        }

        function initSystem() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([50.912, 14.619], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.locate({setView: true, maxZoom: 17});
            loadData();
        }

        // CAMERA & MEDIA
        async function toggleCamera() {
            const cam = document.getElementById('camera-preview');
            const mapEl = document.getElementById('map');
            if (cam.style.opacity === '1') {
                cam.style.opacity = '0'; mapEl.style.opacity = '1';
                if(cam.srcObject) cam.srcObject.getTracks().forEach(t => t.stop());
            } else {
                const stream = await navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}});
                cam.srcObject = stream; cam.style.opacity = '1'; mapEl.style.opacity = '0.3';
            }
        }

        function openCapture() {
            document.getElementById('capture-zone').classList.remove('hidden');
            document.getElementById('main-add-btn').classList.add('hidden');
            if(document.getElementById('camera-preview').style.opacity !== '1') toggleCamera();
        }

        function closeCapture() {
            document.getElementById('capture-zone').classList.add('hidden');
            document.getElementById('main-add-btn').classList.remove('hidden');
            capturedPhotoData = null;
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('p-hint').style.display = 'flex';
        }

        function takePhoto() {
            const video = document.getElementById('camera-preview');
            const canvas = document.getElementById('hidden-canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedPhotoData = canvas.toDataURL('image/jpeg');
            
            document.getElementById('captured-image').src = capturedPhotoData;
            document.getElementById('captured-image').style.display = 'block';
            document.getElementById('p-hint').style.display = 'none';
            playSnd(800, 0.05);
        }

        function toggleRecord() {
            isRecording = !isRecording;
            const btn = document.getElementById('rec-btn');
            if(isRecording) {
                btn.classList.add('record-pulse');
                playSnd(440, 0.1);
            } else {
                btn.classList.remove('record-pulse');
                playSnd(660, 0.1);
            }
        }

        // LOGIC & DATA
        function setMode(m) {
            currentMode = m;
            ['p','b','c'].forEach(id => {
                const el = document.getElementById('m-'+id);
                if(id === m) { el.classList.add('scale-125', 'opacity-100'); el.classList.remove('opacity-30'); el.style.color = themes[id]; }
                else { el.classList.remove('scale-125', 'opacity-100'); el.classList.add('opacity-30'); el.style.color = 'white'; }
            });
        }

        function publishTrace() {
            const text = document.getElementById('trace-text').value;
            const center = map.getCenter();
            
            const trace = {
                id: Date.now(),
                lat: center.lat,
                lng: center.lng,
                text: text || "Byl jsem TADY",
                photo: capturedPhotoData,
                audio: isRecording, // Simulace přítomnosti audia
                mode: currentMode,
                color: themes[currentMode],
                time: new Date().toLocaleTimeString()
            };

            traces.push(trace);
            localStorage.setItem('tady_universe_v1', JSON.stringify(traces));
            renderMarker(trace);
            closeCapture();
            document.getElementById('trace-text').value = '';
            playSnd(1000, 0.2);
        }

        function renderMarker(t) {
            const iconHtml = `<div class="custom-marker" style="background:${t.color}"></div>`;
            const icon = L.divIcon({ className: '', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 24] });
            
            let content = `<div class="p-2 font-bold" style="min-width:150px">
                <div class="text-[10px] uppercase opacity-50 mb-1">${t.time}</div>
                ${t.photo ? `<img src="${t.photo}" style="width:100%; border-radius:10px; margin-bottom:8px">` : ''}
                <div class="text-sm">"${t.text}"</div>
                ${t.audio ? `<div class="mt-2 text-[9px] text-red-500 font-bold"><i class="fas fa-play mr-2"></i>PŘEHRÁT HLAS</div>` : ''}
            </div>`;

            L.marker([t.lat, t.lng], {icon}).addTo(map).bindPopup(content);
        }

        function loadData() {
            const data = localStorage.getItem('tady_universe_v1');
            if(data) {
                traces = JSON.parse(data);
                traces.forEach(renderMarker);
            }
        }

        // AUDIO FEEDBACK
        function playSnd(f, d) {
            const aCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = aCtx.createOscillator();
            const g = aCtx.createGain();
            o.connect(g); g.connect(aCtx.destination);
            o.frequency.value = f;
            g.gain.setValueAtTime(0.05, aCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, aCtx.currentTime + d);
            o.start(); o.stop(aCtx.currentTime + d);
        }
    </script>
</body>
</html>
