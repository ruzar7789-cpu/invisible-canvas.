<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TADY - V코echno d콢le쬴t칠 je tady</title>
    
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --neon: #00f2ff; --tmavy: #0a0a0a; --zlata: #ffd700; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--tmavy); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* 칔vodn칤 obrazovka */
        #splash { position: fixed; inset: 0; z-index: 1000; background: radial-gradient(circle, #002d30 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .logo { font-size: 65px; font-weight: 900; color: var(--neon); text-shadow: 0 0 20px var(--neon); margin: 0; }
        .btn-vstup { background: var(--neon); color: black; border-radius: 50px; padding: 18px 50px; font-weight: bold; cursor: pointer; margin-top: 35px; border: none; text-transform: uppercase; font-size: 18px; }

        /* AR a Mapa */
        #AR-view, #mapa-view { display: none; width: 100%; height: 100vh; position: absolute; top: 0; left: 0; }
        #map-container { width: 100%; height: 100%; }

        /* Menu a ovl치d치n칤 */
        .hlavni-menu { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; background: rgba(0,0,0,0.9); padding: 15px 35px; border-radius: 50px; border: 1px solid var(--neon); z-index: 100; box-shadow: 0 0 15px var(--neon); }
        .menu-ikona { color: var(--neon); font-size: 26px; cursor: pointer; }
        .btn-pridat { position: fixed; bottom: 120px; right: 25px; width: 70px; height: 70px; background: var(--neon); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: black; font-size: 40px; font-weight: bold; z-index: 100; box-shadow: 0 0 25px var(--neon); border: none; cursor: pointer; }

        /* Editor a Diskretn칤 Platba */
        #editor-stop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.97); z-index: 2000; padding: 20px; flex-direction: column; align-items: center; justify-content: center; }
        .karta { background: #151515; border: 2px solid var(--neon); padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 0 30px rgba(0,242,255,0.3); }
        textarea { width: 100%; height: 110px; background: #000; border: 1px solid var(--neon); color: white; padding: 12px; margin: 15px 0; border-radius: 12px; font-size: 16px; resize: none; }
        .btn-platba { background: var(--zlata); color: black; padding: 18px; border-radius: 12px; border: none; font-weight: bold; width: 100%; cursor: pointer; font-size: 17px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="splash">
        <h1 class="logo">TADY</h1>
        <p style="color: #aaa; letter-spacing: 2px;">V코echno d콢le쬴t칠 je tady</p>
        <button class="btn-vstup" onclick="startApp()">VSTOUPIT DO REALITY</button>
    </div>

    <div id="AR-view">
        <button class="btn-pridat" onclick="otevritEditor()">+</button>
        <div class="hlavni-menu">
            <span onclick="prepniNaMapu()" class="menu-ikona">游댌</span>
            <span onclick="prepniNaAR()" class="menu-ikona">游눫</span>
            <span onclick="alert('Profil projektu TADY')" class="menu-ikona">游녻</span>
        </div>
        <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
            <a-camera gps-camera rotation-reader></a-camera>
        </a-scene>
    </div>

    <div id="mapa-view">
        <div id="map-container"></div>
        <div class="hlavni-menu">
            <span onclick="prepniNaMapu()" class="menu-ikona">游댌</span>
            <span onclick="prepniNaAR()" class="menu-ikona">游눫</span>
            <span onclick="alert('Profil projektu TADY')" class="menu-ikona">游녻</span>
        </div>
    </div>

    <div id="editor-stop">
        <div class="karta">
            <h2 style="color:var(--neon); margin-top:0;">NOV츼 STOPA</h2>
            <textarea id="obsah" placeholder="Napi코 vzkaz nebo denn칤 menu..."></textarea>
            
            <div style="background: white; padding: 10px; margin: 15px auto; width: 160px; border-radius: 15px;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=SPD*1.0*ACC:LT533250082844018353*BIC:REVOLT21*AM:29.00*CC:CZK*MSG:TADY_STOPA" 
                     alt="Platba TADY" style="width:100%">
            </div>
            
            <div style="color:var(--zlata); font-size: 24px; font-weight:bold;">29 K캜 / 24h</div>
            <p style="font-size: 12px; color: #888; margin: 10px 0;">Zapla콘 naskenov치n칤m k칩du ve sv칠 bance.</p>
            
            <button class="btn-platba" onclick="ulozitDoDatabeze()">M츼M ZAPLACENO</button>
            <p onclick="zavritEditor()" style="color:#555; margin-top:20px; cursor:pointer; font-size:14px;">Zru코it</p>
        </div>
    </div>

    <script type="module">
        // --- PROPOJEN칈 S NEONEM (RED-THUNDER) ---
        import { neon } from 'https://cdn.jsdelivr.net/npm/@neondatabase/serverless@0.6.0/+esm';
        
        // Tv콢j pln칳 Connection String s heslem Marcel1199
        const DATABASE_URL = 'postgresql://neondb_owner:Marcel1199@ep-white-rain-a2pjt37u-pooler.us-east-2.aws.neon.tech/neondb?sslmode=require';
        const sql = neon(DATABASE_URL);

        let mapa;
        let mojeLat = 50.91;
        let mojeLon = 14.62;

        // Sledov치n칤 GPS polohy u쬴vatele
        navigator.geolocation.watchPosition(pos => {
            mojeLat = pos.coords.latitude;
            mojeLon = pos.coords.longitude;
        }, err => console.error("GPS Error", err), { enableHighAccuracy: true });

        window.startApp = function() {
            document.getElementById('splash').style.display = 'none';
            document.getElementById('AR-view').style.display = 'block';
            nactiStopyZDB();
        };

        window.prepniNaMapu = function() {
            document.getElementById('AR-view').style.display = 'none';
            document.getElementById('mapa-view').style.display = 'block';
            if (!mapa) {
                mapa = L.map('map-container').setView([mojeLat, mojeLon], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapa);
            } else {
                mapa.setView([mojeLat, mojeLon], mapa.getZoom());
            }
        };

        window.prepniNaAR = function() {
            document.getElementById('mapa-view').style.display = 'none';
            document.getElementById('AR-view').style.display = 'block';
        };

        window.otevritEditor = function() { document.getElementById('editor-stop').style.display = 'flex'; };
        window.zavritEditor = function() { document.getElementById('editor-stop').style.display = 'none'; };

        // --- UKL츼D츼N칈 DO DATAB츼ZE ---
        window.ulozitDoDatabeze = async function() {
            const text = document.getElementById('obsah').value;
            if(!text) return alert("Napi코 text vzkazu!");

            try {
                // Zap칤코e vzkaz a tvoji polohu do Neonu
                await sql`INSERT INTO stopy (obsah, lat, lon) VALUES (${text}, ${mojeLat}, ${mojeLon})`;
                
                alert("칔sp캩코n캩 ulo쬰no TADY! Vzkaz se nyn칤 zobraz칤 v코em v okol칤.");
                
                // P콏id치n칤 do sc칠ny hned te캞
                vytvorARVzkaz(text, mojeLat, mojeLon);
                zavritEditor();
            } catch (e) {
                console.error(e);
                alert("Chyba p콏i ukl치d치n칤. Zkontroluj datab치zi Neon.");
            }
        };

        // --- NA캛칈T츼N칈 VECH STOP Z OKOL칈 ---
        async function nactiStopyZDB() {
            try {
                // Vybere jen vzkazy, kter칠 je코t캩 nevypr코ely (24h)
                const stopy = await sql`SELECT obsah, lat, lon FROM stopy WHERE plati_do > NOW()`;
                stopy.forEach(s => vytvorARVzkaz(s.obsah, s.lat, s.lon));
            } catch (e) { console.error("Na캜칤t치n칤 stop selhalo", e); }
        }

        // --- FUNKCE PRO ZOBRAZEN칈 V AR ---
        function vytvorARVzkaz(text, lat, lon) {
            const el = document.createElement('a-text');
            el.setAttribute('value', text);
            el.setAttribute('gps-entity-place', `latitude: ${lat}; longitude: ${lon};`);
            el.setAttribute('look-at', '[gps-camera]');
            el.setAttribute('scale', '20 20 20'); // Velikost vzkazu v prostoru
            el.setAttribute('color', '#00f2ff'); // Neonov캩 modr치
            el.setAttribute('align', 'center');
            el.setAttribute('position', '0 2 0'); // V칳코ka nad zem칤 (2 metry)
            document.querySelector('a-scene').appendChild(el);
        }
    </script>
</body>
</html>

