<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TADY // AR-GHOST-PIN // M.D.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        :root { --p-color: #00f2fe; --b-color: #ffca2c; --c-color: #bf5af2; --active-color: #00f2fe; }
        body, html { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; color: white; margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; }

        #landing-page { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #stars-canvas { position: absolute; inset: 0; z-index: 1; }

        #app-interface { display: none; flex-direction: column; height: 100vh; width: 100vw; position: relative; }
        aside { background: #000; z-index: 5000; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px; flex-shrink: 0; }
        
        #viewer-container { flex-grow: 1; position: relative; background: #050505; }
        #map-bg { height: 100%; width: 100%; z-index: 10; position: absolute; inset: 0; }
        #ar-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5; background: #000; }
        #ar-world { position: absolute; inset: 0; z-index: 20; pointer-events: none; }

        .mode-btn { padding: 8px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; font-size: 8px; font-weight: 900; text-transform: uppercase; color: rgba(255,255,255,0.2); }
        .active-p { border-color: var(--p-color) !important; color: var(--p-color) !important; background: rgba(0,242,254,0.05); }
        .active-b { border-color: var(--b-color) !important; color: var(--b-color) !important; background: rgba(255,202,44,0.05); }
        .active-c { border-color: var(--c-color) !important; color: var(--c-color) !important; background: rgba(191,90,242,0.05); }
        
        .wave-bar { width: 3px; height: 10px; background: var(--active-color); border-radius: 5px; transition: height 0.05s; }
        
        #radar-drawer { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); z-index: 6000; transform: translateY(calc(100% - 60px)); transition: 0.4s; border-radius: 25px 25px 0 0; border: 1px solid rgba(255,255,255,0.1); }
        #radar-drawer.open { transform: translateY(0); }
        .hidden { display: none !important; }
        #img-preview { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; display: none; border: 1px solid var(--active-color); }
    </style>
</head>
<body onclick="resumeAudioContext()">

    <div id="landing-page">
        <canvas id="stars-canvas"></canvas>
        <div class="text-4xl font-black italic tracking-tighter z-10">TADY</div>
        <button onclick="bootApp()" class="mt-12 z-[10000] flex flex-col items-center">
            <div class="w-20 h-20 border border-white/20 rounded-full flex items-center justify-center bg-white/5 backdrop-blur-md relative">
                <i class="fas fa-fingerprint text-3xl"></i>
            </div>
            <div class="text-[8px] tracking-[0.4em] mt-4 opacity-40 uppercase font-bold">M.D. IDENTIFY</div>
        </button>
    </div>

    <div id="app-interface">
        <aside>
            <div class="flex justify-between items-center mb-4">
                <div class="text-xl font-black italic">TADY</div>
                <img id="img-preview" src="" alt="Preview">
            </div>

            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setMode('personal')" id="btn-p" class="mode-btn active-p">Personal<br>29 Kƒç</button>
                <button onclick="setMode('business')" id="btn-b" class="mode-btn">Business<br>199 Kƒç</button>
                <button onclick="setMode('capsule')" id="btn-c" class="mode-btn">Capsule<br>49 Kƒç</button>
            </div>

            <div id="capsule-ui" class="hidden bg-white/5 p-3 rounded-xl mb-4">
                <div class="flex justify-between text-[8px] font-bold mb-2 uppercase text-fuchsia-400"><span>Trv√°n√≠:</span><span id="c-val">24h</span></div>
                <input type="range" id="c-timer" min="1" max="24" value="24" class="w-full h-1 bg-fuchsia-900 rounded-lg appearance-none" oninput="document.getElementById('c-val').innerText = this.value + 'h'">
            </div>

            <input type="text" id="t-title" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-[10px] mb-2 outline-none" placeholder="N√ÅZEV">
            <textarea id="t-desc" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-[10px] h-14 mb-3 outline-none" placeholder="TEXT V PROSTORU..."></textarea>

            <div class="grid grid-cols-4 gap-2 items-center">
                <button onclick="document.getElementById('t-img').click()" class="bg-white/5 p-3 rounded-xl text-[8px] font-bold border border-white/10 uppercase"><i class="fas fa-camera"></i></button>
                <button onclick="toggleAudio()" id="mic-btn" class="bg-white/5 p-3 rounded-xl text-[8px] font-bold border border-white/10 uppercase"><i class="fas fa-microphone"></i></button>
                <div id="viz" class="flex gap-1 h-4 items-center justify-center">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>
                <button onclick="confirmTrace()" id="main-btn" class="bg-cyan-400 text-black py-3 rounded-xl font-black text-[9px] uppercase">PIN</button>
                <input type="file" id="t-img" class="hidden" accept="image/*" onchange="previewImage(this)">
            </div>
        </aside>

        <div id="viewer-container">
            <div id="map-bg"></div>
            <video id="ar-video" autoplay playsinline muted class="hidden"></video>
            <div id="ar-world"></div>
            
            <button onclick="toggleView()" class="absolute top-4 right-4 z-[7000] w-12 h-12 rounded-full bg-white text-black flex items-center justify-center shadow-2xl active:scale-90 transition">
                <i id="view-icon" class="fas fa-expand"></i>
            </button>

            <div id="radar-drawer">
                <div class="h-[60px] flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('radar-drawer').classList.toggle('open')">
                    <div class="w-10 h-1 bg-white/20 rounded-full mb-1"></div>
                    <div id="total-price" class="text-[8px] font-bold uppercase text-cyan-400">Radar M.D.</div>
                </div>
                <div id="trace-list" class="p-4 space-y-2 max-h-[300px] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // STARS
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; stars = []; for(let i=0; i<80; i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2, sp:Math.random()*0.5}); }
        function drawStars() { ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="#fff"; stars.forEach(s=>{ ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); s.y+=s.sp; if(s.y>canvas.height) s.y=0; }); requestAnimationFrame(drawStars); }
        initStars(); drawStars();

        // GLOBALS
        let map, traces = [], currentMode = 'personal', isAR = false, deviceYaw = 0;
        let audioCtx, mediaRecorder, chunks = [], currentAudio = null, isRecording = false, currentImg = null;
        const config = { personal:{c:'#00f2fe', p:29}, business:{c:'#ffca2c', p:199}, capsule:{c:'#bf5af2', p:49} };

        function resumeAudioContext() { if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }

        async function bootApp() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-interface').style.display = 'flex';
            setTimeout(() => {
                map = L.map('map-bg', { zoomControl: false, attributionControl: false }).setView([50.912, 14.619], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                map.invalidateSize();
                loadTraces();
            }, 300);
            window.addEventListener('deviceorientation', e => { if(e.alpha !== null) deviceYaw = e.alpha; renderAR(); });
        }

        function setMode(m) {
            currentMode = m;
            document.documentElement.style.setProperty('--active-color', config[m].c);
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-p', 'active-b', 'active-c'));
            document.getElementById(`btn-${m[0]}`).classList.add(`active-${m[0]}`);
            document.getElementById('main-btn').style.backgroundColor = config[m].c;
            document.getElementById('capsule-ui').classList.toggle('hidden', m !== 'capsule');
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImg = e.target.result;
                    const prev = document.getElementById('img-preview');
                    prev.src = currentImg;
                    prev.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleView() {
            isAR = !isAR;
            const v = document.getElementById('ar-video'), m = document.getElementById('map-bg'), icon = document.getElementById('view-icon');
            if(isAR) {
                navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s => {
                    v.srcObject = s; v.classList.remove('hidden'); m.classList.add('hidden');
                    icon.className = 'fas fa-map'; renderAR();
                });
            } else {
                v.classList.add('hidden'); m.classList.remove('hidden');
                icon.className = 'fas fa-expand'; 
                if(v.srcObject) v.srcObject.getTracks().forEach(t => t.stop());
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        async function toggleAudio() {
            const bars = document.querySelectorAll('.wave-bar');
            const btn = document.getElementById('mic-btn');
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioCtx.createMediaStreamSource(stream);
                    const analyser = audioCtx.createAnalyser();
                    analyser.fftSize = 32; source.connect(analyser);
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/ogg' });
                        const r = new FileReader(); r.onload = e => currentAudio = e.target.result; r.readAsDataURL(blob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('text-red-500');
                    function animateViz() {
                        if(!isRecording) return;
                        analyser.getByteFrequencyData(dataArray);
                        bars.forEach((b, i) => { b.style.height = Math.max(5, dataArray[i]/4) + 'px'; });
                        requestAnimationFrame(animateViz);
                    }
                    animateViz();
                } catch(e) { alert("Mikrofon?"); }
            } else {
                isRecording = false; mediaRecorder.stop();
                btn.classList.remove('text-red-500');
                bars.forEach(b => b.style.height = '5px');
            }
        }

        function confirmTrace() {
            const pos = map.getCenter();
            const h = parseInt(document.getElementById('c-timer').value);
            const data = {
                id: Date.now(), title: document.getElementById('t-title').value || 'Z√°znam',
                desc: document.getElementById('t-desc').value || '', coords: [pos.lat, pos.lng],
                mode: currentMode, audio: currentAudio, img: currentImg, price: config[currentMode].p,
                expiry: currentMode === 'capsule' ? Date.now() + (h * 3600000) : null
            };
            traces.push(data);
            localStorage.setItem('md_traces', JSON.stringify(traces));
            addToList(data);
            renderAR();
            // Reset UI
            document.getElementById('t-title').value = ''; document.getElementById('t-desc').value = '';
            currentAudio = null; currentImg = null; document.getElementById('img-preview').style.display = 'none';
        }

        function addToList(d) {
            const el = document.createElement('div');
            el.className = 'p-3 bg-white/5 rounded-xl border border-white/5 flex justify-between items-center active:scale-95 transition';
            el.onclick = () => { 
                if(d.audio) new Audio(d.audio).play(); 
                map.setView(d.coords, 18);
            };
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    ${d.img ? `<img src="${d.img}" class="w-8 h-8 rounded border border-white/20">` : `<div class="w-8 h-8 bg-white/5 rounded flex items-center justify-center"><i class="fas fa-map-pin text-[10px]"></i></div>`}
                    <div>
                        <div class="text-[10px] font-black italic uppercase">${d.title}</div>
                        <div class="text-[7px]" style="color:${config[d.mode].c}">${d.mode.toUpperCase()} ${d.audio ? 'üîä' : ''}</div>
                    </div>
                </div>
                <div class="text-[9px] opacity-40">${d.price} Kƒç</div>`;
            document.getElementById('trace-list').prepend(el);
        }

        function renderAR() {
            const world = document.getElementById('ar-world'); world.innerHTML = '';
            if(!isAR) return;
            const center = map.getCenter();
            traces.forEach(t => {
                const latDiff = t.coords[0] - center.lat;
                const lngDiff = t.coords[1] - center.lng;
                const x = 50 + (lngDiff * 100000) + ((deviceYaw % 360) * 2.5);
                const y = 50 - (latDiff * 100000);
                const dist = Math.sqrt(latDiff*latDiff + lngDiff*lngDiff);
                if(dist < 0.005) {
                    const card = document.createElement('div');
                    card.style.cssText = `position:absolute; left:${x}%; top:${y}%; padding:8px; border:1px solid ${config[t.mode].c}; background:rgba(0,0,0,0.8); border-radius:8px; transform:translate(-50%,-50%); min-width:80px; pointer-events:auto;`;
                    card.innerHTML = `<div style="color:${config[t.mode].c}; font-size:8px; font-weight:900;">${t.title}</div>${t.img ? `<img src="${t.img}" class="w-full h-10 object-cover mt-1 rounded">`:''}`;
                    world.appendChild(card);
                }
            });
        }

        function loadTraces() {
            const raw = JSON.parse(localStorage.getItem('md_traces') || '[]');
            traces = raw.filter(t => !t.expiry || t.expiry > Date.now());
            document.getElementById('trace-list').innerHTML = '';
            traces.forEach(addToList);
        }
    </script>
</body>
    </html>
    
