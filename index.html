<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TADY // AR-GHOST-PIN // M.D.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        :root { --p-color: #00f2fe; --b-color: #ffca2c; --c-color: #bf5af2; --active-color: #00f2fe; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; color: white; margin: 0; overflow: hidden; touch-action: none; width: 100vw; height: 100vh; }

        /* LANDING */
        #landing-page { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.8s; }
        #stars-canvas { position: absolute; inset: 0; z-index: 1; }
        .glitch-text { font-size: clamp(3rem, 15vw, 6rem); font-weight: 900; font-style: italic; animation: blink 2.5s infinite; z-index: 10; text-transform: uppercase; }
        @keyframes blink { 0%, 100% { opacity: 1; text-shadow: 0 0 30px var(--p-color); } 50% { opacity: 0.5; text-shadow: 0 0 5px var(--p-color); } }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* MAIN UI */
        #app-interface { display: none; height: 100vh; width: 100vw; flex-direction: column; position: relative; }
        #ar-world { position: absolute; inset: 0; z-index: 20; pointer-events: none; perspective: 1200px; }
        #ar-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 5; }
        #map-bg { position: absolute; inset: 0; z-index: 6; transition: 0.4s; }
        
        .ar-card { position: absolute; padding: 12px; border-radius: 15px; border: 2px solid var(--active-color); background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); min-width: 150px; pointer-events: auto; transform: translate(-50%, -50%); }
        .ar-ghost { opacity: 0.6; border-style: dashed; z-index: 2001; animation: float 3s ease-in-out infinite; pointer-events: none; }
        @keyframes float { 0%, 100% { transform: translate(-50%, -55%); } 50% { transform: translate(-50%, -45%); } }

        /* ASIDE & RADAR */
        aside { z-index: 5000; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); }
        .active-p { border-color: var(--p-color) !important; color: var(--p-color) !important; background: rgba(0,242,254,0.1); }
        .active-b { border-color: var(--b-color) !important; color: var(--b-color) !important; background: rgba(255,202,44,0.1); }
        .active-c { border-color: var(--c-color) !important; color: var(--c-color) !important; background: rgba(191,90,242,0.1); }
        .wave-bar { width: 3px; height: 5px; background: var(--active-color); border-radius: 10px; transition: 0.1s; }
        
        #radar-panel { position: absolute; bottom: 0; left: 0; right: 0; background: #050505; z-index: 6000; transition: 0.5s; transform: translateY(calc(100% - 70px)); border-radius: 30px 30px 0 0; border-top: 1px solid rgba(255,255,255,0.1); }
        #radar-panel.open { transform: translateY(0); }
    </style>
</head>
<body>

    <div id="landing-page">
        <canvas id="stars-canvas"></canvas>
        <div class="glitch-text">TADY</div>
        <div onclick="bootApp()" class="mt-16 z-[10000] flex flex-col items-center cursor-pointer active:scale-90">
            <div class="w-20 h-20 border border-white/20 rounded-full flex items-center justify-center bg-white/5 backdrop-blur-md relative overflow-hidden">
                <i class="fas fa-fingerprint text-3xl"></i>
                <div class="absolute w-full h-[2px] bg-cyan-400 top-0 animate-[scan_2s_infinite]"></div>
            </div>
            <div class="text-[8px] font-bold tracking-[0.4em] mt-4 text-white/40 uppercase">Identify M.D.</div>
        </div>
    </div>

    <div id="app-interface">
        <div id="ar-world"></div>
        
        <aside class="w-full md:w-[350px] p-6 flex flex-col border-r border-white/10 h-full relative">
            <div class="mb-6"><div class="text-2xl font-black italic">TADY</div><div class="text-[7px] text-cyan-400 tracking-[0.5em] uppercase">Digital Core System</div></div>
            
            <div class="space-y-4 flex-1 overflow-y-auto pr-2">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setMode('personal')" id="btn-p" class="p-2 rounded-xl border border-white/10 text-[8px] font-black active-p uppercase">Personal<span class="block opacity-50">29 K캜</span></button>
                    <button onclick="setMode('business')" id="btn-b" class="p-2 rounded-xl border border-white/10 text-[8px] font-black text-white/20 uppercase">Business<span class="block opacity-50">199 K캜</span></button>
                    <button onclick="setMode('capsule')" id="btn-c" class="p-2 rounded-xl border border-white/10 text-[8px] font-black text-white/20 uppercase">Capsule<span class="block opacity-50">49 K캜</span></button>
                </div>

                <div id="capsule-settings" class="hidden bg-white/5 p-3 rounded-xl border border-white/5">
                    <label class="text-[7px] uppercase font-bold text-fuchsia-400">Doba trv치n칤 (v hodin치ch)</label>
                    <input type="range" id="c-timer" min="1" max="24" value="24" class="w-full h-1 bg-fuchsia-900 rounded-lg appearance-none cursor-pointer mt-2" oninput="document.getElementById('c-val').innerText = this.value + 'h'">
                    <div id="c-val" class="text-[10px] text-right">24h</div>
                </div>

                <input type="text" id="t-title" oninput="updateGhost()" class="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-[10px] text-white outline-none" placeholder="N츼ZEV ZPR츼VY">
                <textarea id="t-desc" oninput="updateGhost()" class="w-full p-3 bg-white/5 border border-white/10 rounded-xl text-[10px] h-16 text-white outline-none" placeholder="OBSAH V PROSTORU..."></textarea>
                
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="document.getElementById('t-img').click()" class="bg-white/5 p-3 rounded-xl text-[8px] font-bold uppercase border border-white/5">P콏idat Foto</button>
                    <button onclick="toggleAudio()" id="mic-btn" class="bg-white/5 p-3 rounded-xl text-[8px] font-bold uppercase border border-white/5">Audio</button>
                    <input type="file" id="t-img" class="hidden" accept="image/*" onchange="previewImage(this)">
                </div>

                <div id="viz-container" class="flex justify-center items-end gap-1 h-4">
                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                </div>

                <button onclick="confirmTrace()" id="main-action-btn" class="w-full bg-cyan-400 text-black py-4 rounded-full font-black text-[10px] uppercase tracking-widest">P콎IPENDLIT</button>
            </div>
        </aside>

        <main class="flex-1 relative bg-black overflow-hidden h-full">
            <video id="ar-video" autoplay playsinline muted></video>
            <div id="map-bg"></div>
            <button onclick="toggleCam()" class="absolute top-4 right-4 z-[7000] w-10 h-10 rounded-full bg-white text-black flex items-center justify-center shadow-lg active:scale-90 transition-transform"><i class="fas fa-camera"></i></button>
            
            <div id="radar-panel">
                <div class="h-[70px] flex flex-col items-center justify-center cursor-pointer" onclick="document.getElementById('radar-panel').classList.toggle('open')">
                    <div class="w-8 h-1 bg-white/20 rounded-full mb-1"></div>
                    <div id="total-price-display" class="text-[8px] font-black text-cyan-400 tracking-widest uppercase">0 Z치znam콢</div>
                </div>
                <div class="p-4 space-y-2 max-h-[300px] overflow-y-auto" id="radar-list"></div>
            </div>
        </main>
    </div>

    <script>
        // STARS
        const canvas = document.getElementById('stars-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function initStars() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; stars = []; for(let i=0; i<100; i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2, sp:Math.random()*0.5}); }
        function drawStars() { ctx.fillStyle="#000"; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.fillStyle="#fff"; stars.forEach(s=>{ ctx.beginPath(); ctx.arc(s.x,s.y,s.s,0,Math.PI*2); ctx.fill(); s.y+=s.sp; if(s.y>canvas.height) s.y=0; }); requestAnimationFrame(drawStars); }
        initStars(); drawStars();

        // CORE VARS
        let map, traces = [], currentMode = 'personal', isCam = false, deviceYaw = 0;
        let audioCtx, mediaRecorder, chunks = [], currentAudio = null, isRecording = false;
        const config = { personal: {color:'#00f2fe', price:29}, business: {color:'#ffca2c', price:199}, capsule: {color:'#bf5af2', price:49} };

        async function bootApp() {
            if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') { await DeviceOrientationEvent.requestPermission(); }
            window.addEventListener('deviceorientation', e => { if(e.alpha !== null) deviceYaw = e.alpha; renderAR(); });

            document.getElementById('landing-page').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('landing-page').style.display = 'none';
                document.getElementById('app-interface').style.display = 'flex';
                initMap();
                loadTraces();
            }, 800);
        }

        function initMap() {
            map = L.map('map-bg', { zoomControl: false, attributionControl: false }).setView([50.912, 14.619], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_all/{z}/{x}/{y}{r}.png').addTo(map);
            map.on('move', renderAR);
        }

        function setMode(m) {
            currentMode = m;
            document.documentElement.style.setProperty('--active-color', config[m].color);
            document.querySelectorAll('aside button').forEach(b => b.className = b.className.replace(/active-[pbc]/, '').replace('text-white', 'text-white/20'));
            document.getElementById(`btn-${m[0]}`).classList.add(`active-${m[0]}`);
            document.getElementById(`btn-${m[0]}`).classList.remove('text-white/20');
            document.getElementById('main-action-btn').style.backgroundColor = config[m].color;
            document.getElementById('capsule-settings').style.display = (m === 'capsule') ? 'block' : 'none';
            updateGhost();
        }

        function updateGhost() {
            const world = document.getElementById('ar-world');
            let ghost = document.querySelector('.ar-ghost');
            if(!ghost) { ghost = document.createElement('div'); ghost.className = 'ar-card ar-ghost'; world.appendChild(ghost); }
            ghost.style.left = '50%'; ghost.style.top = '50%';
            ghost.style.borderColor = config[currentMode].color;
            ghost.innerHTML = `<div class="text-[9px] font-black italic uppercase" style="color:${config[currentMode].color}">${document.getElementById('t-title').value || 'N츼HLED'}</div><div class="text-[8px] opacity-70">${document.getElementById('t-desc').value || '...'}</div>`;
        }

        async function toggleAudio() {
            const bars = document.querySelectorAll('.wave-bar');
            if(!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    chunks = [];
                    mediaRecorder.ondataavailable = e => chunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
                        const r = new FileReader(); r.onload = e => currentAudio = e.target.result; r.readAsDataURL(blob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('mic-btn').classList.add('bg-red-500');
                    // Simple Visualizer
                    audioCtx = new AudioContext();
                    const src = audioCtx.createMediaStreamSource(stream);
                    const ana = audioCtx.createAnalyser(); src.connect(ana); ana.fftSize = 32;
                    const data = new Uint8Array(ana.frequencyBinCount);
                    function loop() { if(!isRecording) return; ana.getByteFrequencyData(data); bars.forEach((b,i)=>b.style.height=(5+data[i]/10)+'px'); requestAnimationFrame(loop); }
                    loop();
                } catch(e) { alert("Mikrofon?"); }
            } else {
                isRecording = false;
                mediaRecorder.stop();
                document.getElementById('mic-btn').classList.remove('bg-red-500');
                bars.forEach(b => b.style.height = '5px');
            }
        }

        function confirmTrace() {
            const center = map.getCenter();
            const h = parseInt(document.getElementById('c-timer').value);
            const d = {
                id: Date.now(), title: document.getElementById('t-title').value || 'Z치znam',
                desc: document.getElementById('t-desc').value || '', coords: [center.lat, center.lng],
                mode: currentMode, price: config[currentMode].price, audio: currentAudio,
                expiry: currentMode === 'capsule' ? Date.now() + (h * 3600000) : null
            };
            traces.push(d);
            localStorage.setItem('md_traces', JSON.stringify(traces));
            addUI(d);
            renderAR();
            document.getElementById('t-title').value = ''; document.getElementById('t-desc').value = ''; currentAudio = null;
        }

        function addUI(d) {
            const item = document.createElement('div');
            item.className = 'p-3 bg-white/5 rounded-xl border border-white/5 flex justify-between items-center';
            item.onclick = () => { if(d.audio) new Audio(d.audio).play(); map.setView(d.coords, 18); };
            item.innerHTML = `<div><div class="text-[9px] font-black uppercase italic">${d.title}</div><div class="text-[7px]" style="color:${config[d.mode].color}">${d.mode.toUpperCase()} ${d.audio ? '游댉' : ''}</div></div><div class="text-[9px] opacity-40">${d.price} K캜</div>`;
            document.getElementById('radar-list').prepend(item);
            document.getElementById('total-price-display').innerText = `${traces.length} Z츼ZNAM콡`;
        }

        function loadTraces() {
            const raw = JSON.parse(localStorage.getItem('md_traces') || '[]');
            traces = raw.filter(t => !t.expiry || t.expiry > Date.now());
            traces.forEach(addUI);
        }

        function renderAR() {
            const world = document.getElementById('ar-world');
            const ghost = document.querySelector('.ar-ghost');
            Array.from(world.children).forEach(c => { if(c !== ghost) c.remove(); });
            if (!isCam) return;

            const center = map.getCenter();
            traces.forEach(t => {
                const latDiff = t.coords[0] - center.lat;
                const lngDiff = t.coords[1] - center.lng;
                const x = 50 + (lngDiff * 80000) + ((deviceYaw % 360) * 2.5);
                const y = 50 - (latDiff * 80000);
                const dist = Math.sqrt(latDiff*latDiff + lngDiff*lngDiff);

                if (dist < 0.01) {
                    const card = document.createElement('div');
                    card.className = 'ar-card';
                    card.style.left = `${x}%`; card.style.top = `${y}%`;
                    card.style.borderColor = config[t.mode].color;
                    card.style.transform = `translate(-50%, -50%) scale(${Math.max(0.2, 1 - dist*100)})`;
                    card.onclick = () => { if(t.audio) new Audio(t.audio).play(); };
                    card.innerHTML = `<div style="color:${config[t.mode].color}" class="text-[9px] font-black uppercase">${t.title}</div><div class="text-[7px] opacity-70">${t.desc}</div>`;
                    world.appendChild(card);
                }
            });
        }

        function toggleCam() {
            const v = document.getElementById('ar-video'), m = document.getElementById('map-bg');
            if(!isCam) {
                navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s => {
                    v.srcObject = s; v.style.display = 'block'; m.style.opacity = '0.1'; isCam = true; renderAR();
                });
            } else { v.style.display = 'none'; m.style.opacity = '1'; isCam = false; if(v.srcObject) v.srcObject.getTracks()[0].stop(); renderAR(); }
        }

        function previewImage(i) { /* Zpracov치n칤 Base64 image */ }
    </script>
</body>
</html>
