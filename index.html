<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TADY // NEON CONNECTED</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;400;600;800&display=swap');
        :root { --p: #00f2fe; --neon: #00ffa3; }
        body, html { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; color: white; margin: 0; padding: 0; overflow: hidden; height: 100vh; }

        /* INTRO */
        #intro { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 1s; }
        .logo { font-size: 5rem; font-weight: 800; font-style: italic; letter-spacing: -5px; animation: glow 2s infinite; }
        @keyframes glow { 0%, 100% { text-shadow: 0 0 20px var(--p); } 50% { text-shadow: 0 0 40px var(--neon); } }

        #map { position: fixed; inset: 0; z-index: 10; }
        .glass { background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 30px; }
        
        /* STATUS INDICATOR */
        #db-status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; font-size: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="intro">
        <div class="logo">TADY</div>
        <div class="text-[8px] tracking-[1em] opacity-30 uppercase mt-4">Database: NEON.TECH</div>
        <button onclick="launch()" class="mt-12 px-10 py-3 border border-white/20 rounded-full text-[10px] font-bold tracking-[0.3em] uppercase">Initialize Link</button>
    </div>

    <div id="db-status" class="glass px-4 py-2 flex items-center gap-2">
        <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
        <span id="status-text">Neon Sync: Standby</span>
    </div>

    <div id="map"></div>

    <div class="fixed inset-0 z-[100] pointer-events-none p-6 flex flex-col justify-end">
        <div class="w-full max-w-md mx-auto pointer-events-auto">
            <div class="glass p-6 mb-4">
                <input type="text" id="trace-input" placeholder="Zanech stopu v databázi..." class="w-full bg-white/5 p-4 rounded-xl mb-4 outline-none border border-white/10 focus:border-cyan-400 font-bold">
                <button onclick="saveToNeon()" class="w-full bg-white text-black py-5 rounded-2xl font-black text-[10px] tracking-[0.4em] uppercase">Odeslat do světa</button>
            </div>
        </div>
    </div>

    <script>
        let map, traces = [], audioCtx;

        function launch() {
            document.getElementById('intro').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('intro').style.display = 'none';
                initApp();
            }, 1000);
        }

        function initApp() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([50.912, 14.619], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // NAČTENÍ DAT
            fetchTraces();
        }

        // TATO FUNKCE BUDE VOLAT TVŮJ VERCEL BACKEND
        async function fetchTraces() {
            setStatus('Synchronizing...', 'yellow');
            try {
                // Tady bude URL tvé Vercel funkce, např: /api/get-traces
                const response = await fetch('/api/traces'); 
                if(response.ok) {
                    const data = await response.json();
                    data.forEach(renderMarker);
                    setStatus('Neon Online', '#00ffa3');
                } else {
                    // Pokud ještě nemáš API, načteme aspoň lokální pro test
                    loadLocal();
                    setStatus('Neon Offline (Local Mode)', 'orange');
                }
            } catch(e) {
                loadLocal();
                setStatus('Neon Offline (Local Mode)', 'orange');
            }
        }

        async function saveToNeon() {
            const text = document.getElementById('trace-input').value;
            const pos = map.getCenter();
            
            const newTrace = {
                lat: pos.lat,
                lng: pos.lng,
                content: text,
                timestamp: new Date().toISOString()
            };

            setStatus('Uploading...', 'blue');

            try {
                // Tady bude volání tvého API pro zápis do Neonu
                const response = await fetch('/api/save-trace', {
                    method: 'POST',
                    body: JSON.stringify(newTrace)
                });

                if(response.ok) {
                    renderMarker(newTrace);
                    setStatus('Neon Updated', '#00ffa3');
                } else {
                    throw new Error();
                }
            } catch(e) {
                // Nouzové uložení lokálně, když nejede API
                saveLocal(newTrace);
                renderMarker(newTrace);
                setStatus('Saved Locally', 'orange');
            }
            
            document.getElementById('trace-input').value = '';
        }

        function renderMarker(t) {
            const icon = L.divIcon({
                className: '',
                html: `<div style="width:20px; height:20px; background:#00ffa3; border-radius:50%; border:3px solid white; box-shadow:0 0 15px rgba(0,255,163,0.5)"></div>`,
                iconSize: [20, 20]
            });
            L.marker([t.lat, t.lng], {icon}).addTo(map).bindPopup(`<b style="color:black">${t.content}</b>`);
        }

        function setStatus(txt, color) {
            document.getElementById('status-text').innerText = 'Neon: ' + txt;
            document.getElementById('status-dot').style.backgroundColor = color;
        }

        function saveLocal(t) {
            traces.push(t);
            localStorage.setItem('tady_neon_fallback', JSON.stringify(traces));
        }

        function loadLocal() {
            const data = localStorage.getItem('tady_neon_fallback');
            if(data) {
                JSON.parse(data).forEach(renderMarker);
            }
        }

        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    </script>
</body>
</html>
